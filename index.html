<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Indicadores – Escritório de Operações</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --danger: #b91c1c;
      --success: #047857;
      --warning: #b45309;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
    }
    h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }
    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .tag-small {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .card {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      box-shadow: 0 3px 10px rgba(15,23,42,.05);
    }
    .card-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: 3px;
    }
    .card-value {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .card-sub {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 8px;
      margin-bottom: 12px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.75rem;
    }
    .filter-group label {
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
    }
    select, input[type="search"] {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      background: #f9fafb;
    }
    select:focus, input[type="search"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
      background: #ffffff;
    }

    .layout-two {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (min-width: 900px) {
      .layout-two {
        grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      }
    }

    .panel {
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      box-shadow: 0 3px 10px rgba(15,23,42,.05);
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .panel-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .life-summary {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .life-summary ul {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
    }
    .life-summary li {
      margin-bottom: 3px;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }
    .status-nao-iniciado .status-dot {
      background: var(--muted);
    }
    .status-execucao .status-dot {
      background: var(--warning);
    }
    .status-concluido .status-dot {
      background: var(--success);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    thead th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:hover {
      background: #f3f4f6;
    }
    .scroll-table {
      max-height: 360px;
      overflow: auto;
      margin-top: 6px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .footer-note {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn-toggle {
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 0.75rem;
      background: #f9fafb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-toggle:hover {
      background: #e5e7eb;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="tag-small">
        <span class="tag-dot"></span>
        <span>Indicadores · Escritório de operações</span>
      </div>
      <h1>Portfólio de estudos – visão geral</h1>
      <div class="subtitle">
        Tendência anual, projeção 2026 baseada em 70 estudos e redistribuição mensal mantendo o padrão observado no recorte atual.
      </div>
    </div>
    <div style="font-size:0.75rem; color:var(--muted); text-align:right;">
      Fonte: planilha “INDICADORES - GP”.<br>
      Atualização local via upload do arquivo.
    </div>
  </header>

  <section class="cards" id="cards-summary">
  </section>

  <section class="filters">
    <div class="filter-group">
      <label for="filter-year">Ano de abertura (apenas tabela/cards)</label>
      <select id="filter-year">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-especialidade">Especialidade</label>
      <select id="filter-especialidade">
        <option value="">Todas</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-pilar">Pilar</label>
      <select id="filter-pilar">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-lider">Líder</label>
      <select id="filter-lider">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-status">Status</label>
      <select id="filter-status">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-busca">Busca livre</label>
      <input id="filter-busca" type="search" placeholder="Título, palavra-chave…">
    </div>
  </section>

  <section class="layout-two">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Tendência anual de estudos (por filtro)</div>
          <div class="panel-subtitle">
            A linha mostra o histórico anual do recorte atual. O ponto de 2026 é a projeção (70 estudos) e a faixa indica a zona alvo.
          </div>
        </div>
        <div class="pill" id="pill-anual-info">Projeção 2026: 70 estudos</div>
      </div>
      <canvas id="chartAnual"></canvas>
      <div class="panel-subtitle" style="margin-top:6px;">
        Projeção 2026 fixa em 70 estudos, com base na trajetória observada após aplicação dos filtros (especialidade, pilar, líder, status).
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Distribuição mensal – 2025 vs 2026 (projeção, por filtro)</div>
          <div class="panel-subtitle">
            2025 = volume real. 2026 = projeção flutuante, mantendo o mesmo perfil mensal de 2025 e escalonando para 70 estudos anuais.
          </div>
        </div>
        <div class="pill" id="pill-mensal-info">Base 2025 · Projeção 2026</div>
      </div>
      <canvas id="chartMensal"></canvas>
      <div class="panel-subtitle" style="margin-top:6px;">
        2026 é escalonado para atingir 70 estudos no ano, preservando o peso relativo de cada mês observado em 2025 dentro do filtro atual.
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title">Ciclo de vida dos projetos</div>
        <div class="panel-subtitle">
          Classificação baseada em início e fim de execução, comparando com a data de hoje.
        </div>
      </div>
    </div>
    <div class="life-summary" id="life-summary">
    </div>
  </section>

  <section class="panel" style="margin-top:12px;">
    <div class="panel-header">
      <div>
        <div class="panel-title">Lista de projetos</div>
        <div class="panel-subtitle">Inclui datas de abertura, execução, orçamento e overhead (respeitando todos os filtros).</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:0.75rem; color:var(--muted);">
          <span id="count-projetos">0</span> projeto(s) filtrado(s)
        </span>
        <button id="toggle-table-btn" class="btn-toggle">
          Mostrar tabela detalhada
        </button>
      </div>
    </div>
    <div id="table-wrapper" style="display:none;">
      <div class="scroll-table">
        <table>
          <thead>
            <tr>
              <th>Projeto</th>
              <th>Especialidade</th>
              <th>Pilar</th>
              <th>Líder</th>
              <th>Status</th>
              <th>Abertura</th>
              <th>Início exec.</th>
              <th>Fim exec.</th>
              <th>Orçamento (R$)</th>
              <th>Overhead (R$)</th>
            </tr>
          </thead>
          <tbody id="table-body">
          </tbody>
        </table>
      </div>
      <div class="footer-note">
        <span>Datas de execução em branco são interpretadas como estudos em fase de planejamento / pré-início.</span>
        <span>Pode ser versionado por mês (snapshot) para acompanhar evolução do portfólio.</span>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const projects = [{"Título Reduzido": "MEDICINA INTENSIVA - PFIZER RWE VACINAS", "Data de abertura de Projeto": "2025-01-14", "Status do Projeto": "Em negociação", "Especialidade": "Medicina intensiva", "Tipo de estudo": "Observacional", "Relação temporal": null, "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "ONCOLOGIA - IDOR ARCTURUS 25", "Data de abertura de Projeto": "2025-01-15", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 1084991.35, "OVERHEAT": 216998.27}, {"Título Reduzido": "MEDICINA INTENSIVA - NULYN SCIENCE", "Data de abertura de Projeto": "2025-01-14", "Status do Projeto": "Em negociação", "Especialidade": "Medicina intensiva", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 492560.1, "OVERHEAT": 98512.02}, {"Título Reduzido": "MEDICINA INTENSIVA - VÍRUS RESPIRATÓRIOS AZ", "Data de abertura de Projeto": "2025-10-08", "Status do Projeto": "Em negociação", "Especialidade": "Medicina intensiva", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "MEDICINA INTENSIVA - VANTIVE IIR", "Data de abertura de Projeto": "2025-03-20", "Status do Projeto": "Em negociação", "Especialidade": "Medicina intensiva", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 829920.0, "OVERHEAT": 165984.0}, {"Título Reduzido": "ONCOLOGIA - LB2401 LIBBS", "Data de abertura de Projeto": "2022-03-22", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Sim", "Início da execução": "2025-01-15", "Fim da execução": "2028-07-30", "ORÇAMENTO": 95600.0, "OVERHEAT": 19120.0}, {"Título Reduzido": "ONCOLOGIA - AZ - DENILA", "Data de abertura de Projeto": "2024-07-22", "Status do Projeto": "Iniciação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Sim", "Início da execução": "2025-11-24", "Fim da execução": "2027-04-01", "ORÇAMENTO": 965794.4214, "OVERHEAT": 193158.88428}, {"Título Reduzido": "ONCOLOGIA - BMS - CA209-1529", "Data de abertura de Projeto": "2025-07-25", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2024-11-21", "Fim da execução": "2026-07-30", "ORÇAMENTO": 457355.91000000003, "OVERHEAT": 91471.18200000002}, {"Título Reduzido": "ONCOLOGIA - DESPATIL - Renata Bonadio", "Data de abertura de Projeto": "2024-10-28", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "API", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Sim", "Necessidade de apoio do recrutamento?": "Sim", "Início da execução": "2026-01-30", "Fim da execução": "2027-07-30", "ORÇAMENTO": 200000.0, "OVERHEAT": 40000.0}, {"Título Reduzido": "ONCOLOGIA - EPIDEMIOLOGIA DE TUMORES PRIMÁRIOS DO SNC", "Data de abertura de Projeto": "2025-02-25", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "API", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Sim", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2024-11-11", "Fim da execução": "2025-12-30", "ORÇAMENTO": 0.0, "OVERHEAT": 0.0}, {"Título Reduzido": "ONCOLOGIA - CA BEXIGA NÃO-MÚSCULO INVASIVO", "Data de abertura de Projeto": "2025-04-28", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "API", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": null, "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2025-11-10", "Fim da execução": "2026-07-30", "ORÇAMENTO": 242621.26, "OVERHEAT": 48524.252}, {"Título Reduzido": "HEMATOLOGIA - ROCHE - POLA-R-CHP - LUIZA LAPOLLA", "Data de abertura de Projeto": "2025-11-06", "Status do Projeto": "Planejamento", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Sim", "Necessidade de apoio do recrutamento?": "Sim", "Início da execução": "2026-04-30", "Fim da execução": "2027-04-30", "ORÇAMENTO": 751186.54, "OVERHEAT": 150237.30800000002}, {"Título Reduzido": "ONCOLOGIA - IASLC- ADENOCARCINOMA - THAMIRES", "Data de abertura de Projeto": "2025-01-07", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-02-28", "Fim da execução": "2028-02-28", "ORÇAMENTO": 286000.0, "OVERHEAT": 57200.0}, {"Título Reduzido": "ONCOLOGIA MSD - CA BEXIGA - Daniel Herchenhorn", "Data de abertura de Projeto": "2025-05-29", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2026-02-28", "Fim da execução": "2028-02-28", "ORÇAMENTO": 861728.1, "OVERHEAT": 172345.62}, {"Título Reduzido": "ONCOLOGIA - cabozantinibe t-NEPC", "Data de abertura de Projeto": "2025-07-01", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2026-04-30", "Fim da execução": "2029-04-30", "ORÇAMENTO": 2393005.54, "OVERHEAT": 478601.10799999995}, {"Título Reduzido": "ONCOLOGIA - EXELIXIS", "Data de abertura de Projeto": "2025-03-26", "Status do Projeto": null, "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2026-04-30", "Fim da execução": "2028-04-30", "ORÇAMENTO": 1046949.04, "OVERHEAT": 209389.80800000002}, {"Título Reduzido": "ORTOPEDIA - ARTHREX PRP JOELHO", "Data de abertura de Projeto": "2022-11-04", "Status do Projeto": "Em negociação", "Especialidade": "Ortopedia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2026-01-10", "Fim da execução": "2027-11-30", "ORÇAMENTO": 257400.0, "OVERHEAT": 51480.0}, {"Título Reduzido": "PEDIATRIA - SHIPPSS TRIAL", "Data de abertura de Projeto": "2022-02-11", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Pediatria", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": null, "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2023-03-19", "Fim da execução": "2026-09-30", "ORÇAMENTO": 211200.0, "OVERHEAT": 42240.0}, {"Título Reduzido": "CIRURGIA - ROBOPERA ENDOCUBOT", "Data de abertura de Projeto": "2025-10-23", "Status do Projeto": "Planejamento", "Especialidade": "Cirurgia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Sim", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2026-03-30", "Fim da execução": "2027-03-30", "ORÇAMENTO": 2757439.12, "OVERHEAT": 551487.824}, {"Título Reduzido": "ONCOLOGIA - HER REAL DAICHII", "Data de abertura de Projeto": "2024-07-25", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Camilla Alves Ferreira", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": "2026-03-30", "Fim da execução": "2027-03-30", "ORÇAMENTO": 343805.0, "OVERHEAT": 68761.0}, {"Título Reduzido": "ONCOLOGIA  - MSD - CASPER 149", "Data de abertura de Projeto": "2025-10-28", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "CRO", "Lider": "Guilherme Cezar Ambrósio", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-03-30", "Fim da execução": "2027-03-30", "ORÇAMENTO": 1312000.0, "OVERHEAT": 262400.0}, {"Título Reduzido": "HEMATOLOGIA - CART - LUZA LAPOLLA ", "Data de abertura de Projeto": "2025-11-11", "Status do Projeto": "Planejamento", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Guilherme Cezar Ambrósio", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-05-30", "Fim da execução": "2029-05-30", "ORÇAMENTO": 972121.39, "OVERHEAT": 194424.27800000002}, {"Título Reduzido": "API - DADOS - GINECOLOGIA - DRA CLANDICE", "Data de abertura de Projeto": "2025-11-25", "Status do Projeto": "Planejamento", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "API", "Lider": "Guilherme Cezar Ambrósio", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "ORTOPEDIA - VELYS - johnson & Johnson - Dra Maria Eugenia Leite Duarte", "Data de abertura de Projeto": "2025-11-18", "Status do Projeto": "Planejamento", "Especialidade": "Ortopedia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Guilherme Cezar Ambrósio", "Necessidade de deliberação?": "Sim", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-02-28", "Fim da execução": "2027-02-28", "ORÇAMENTO": 19000.0, "OVERHEAT": 3800.0}, {"Título Reduzido": "MEDICINA INTENSIVA - CCAA WELCOME AWARD", "Data de abertura de Projeto": "2023-07-17", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Cardiologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2024-01-30", "Fim da execução": "2025-12-30", "ORÇAMENTO": 1152350.57, "OVERHEAT": 230470.11400000003}, {"Título Reduzido": "CARDIOLOGIA - TAVIDOR", "Data de abertura de Projeto": "2022-01-01", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Cardiologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo;#Retrospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2025-11-30", "Fim da execução": "2030-11-30", "ORÇAMENTO": 448125.0, "OVERHEAT": 89625.0}, {"Título Reduzido": "HEMATOLOGIA - REGISTRO LMA", "Data de abertura de Projeto": "2025-07-28", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Hematologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2022-01-30", "Fim da execução": "2026-12-30", "ORÇAMENTO": 75000.0, "OVERHEAT": 0.0}, {"Título Reduzido": "HEMATOLOGIA - CIBMTR", "Data de abertura de Projeto": "2025-08-26", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Hematologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo;#Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Não", "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "IMAGEM - FMRI UFF LPI (ID55)", "Data de abertura de Projeto": "2024-04-25", "Status do Projeto": "Iniciação", "Especialidade": "Imagem", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "MEDICINA INTENSIVA - SPARE", "Data de abertura de Projeto": "2023-03-02", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Medicina intensiva", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": " ", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2025-11-30", "Fim da execução": "2030-11-30", "ORÇAMENTO": 832356.0, "OVERHEAT": 166471.2}, {"Título Reduzido": "NEUROCIÊNCIAS - FENFLURAMINA DRAVET", "Data de abertura de Projeto": "2023-05-17", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Neurociências", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2025-08-30", "Fim da execução": "2026-08-30", "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "NEUROCIÊNCIAS - BRIDGE & WELLCOME TRUST UTAUS", "Data de abertura de Projeto": "2023-07-25", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Neurociências", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2025-08-30", "Fim da execução": "2026-08-30", "ORÇAMENTO": 553089.0, "OVERHEAT": 110617.8}, {"Título Reduzido": "NEUROCIÊNCIAS - WILD RELIGIONS", "Data de abertura de Projeto": "2024-04-01", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Neurociências", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2024-08-30", "Fim da execução": "2026-08-30", "ORÇAMENTO": 479829.52, "OVERHEAT": 95965.90400000001}, {"Título Reduzido": "OFTALMOLOGIA - MSD - NIS107414", "Data de abertura de Projeto": "2025-10-28", "Status do Projeto": "Em negociação", "Especialidade": "Oftalmologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "CRO", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-03-30", "Fim da execução": "2027-03-30", "ORÇAMENTO": 500000.0, "OVERHEAT": 100000.0}, {"Título Reduzido": "ONCOLOGIA - GBECAM - CMTN - Jose Bines", "Data de abertura de Projeto": "2025-04-22", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 50000.0, "OVERHEAT": 10000.0}, {"Título Reduzido": "ONCOLOGIA - JANSSEN - TESTE MOLECULAR", "Data de abertura de Projeto": "2025-07-08", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": null, "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 1625700.0, "OVERHEAT": 325140.0}, {"Título Reduzido": "ONCOLOGIA - DARO PET PSMA", "Data de abertura de Projeto": "2023-01-02", "Status do Projeto": "Encerramento", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": null, "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2024-04-30", "Fim da execução": "2025-12-30", "ORÇAMENTO": 80000.0, "OVERHEAT": 16000.0}, {"Título Reduzido": "ONCOLOGIA - ANTARES FINEP ICESP", "Data de abertura de Projeto": "2024-04-23", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": "Sim", "Início da execução": "2025-06-30", "Fim da execução": "2027-06-30", "ORÇAMENTO": 2111768.68, "OVERHEAT": 422353.73600000003}, {"Título Reduzido": "ONCOLOGIA - RWE MSD CA RENAL", "Data de abertura de Projeto": "2024-09-14", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2025-01-30", "Fim da execução": "2025-12-30", "ORÇAMENTO": 1665050.4, "OVERHEAT": 333010.08}, {"Título Reduzido": "ONCOLOGIA - GILEAD - SACITUZUMAB - Renata Bonadio", "Data de abertura de Projeto": "2025-02-14", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-03-30", "Fim da execução": "2027-03-30", "ORÇAMENTO": 150000.0, "OVERHEAT": 30000.0}, {"Título Reduzido": "ONCOLOGIA - ROCHE - Dra. Renata Bonadio", "Data de abertura de Projeto": "2025-07-22", "Status do Projeto": "Execução - Monitoramento e controle", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "CRO", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "30/02/2026", "Fim da execução": "30/02/2027", "ORÇAMENTO": 150000.0, "OVERHEAT": 30000.0}, {"Título Reduzido": "ONCOLOGIA - AZ - CANCER PULMÃO NEMO", "Data de abertura de Projeto": "2025-04-16", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "CRO", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": "2026-03-30", "Fim da execução": "2031-01-30", "ORÇAMENTO": 2422773.1, "OVERHEAT": 484554.62}, {"Título Reduzido": "ONCOLOGIA - AZ - HEPATOBILIAR", "Data de abertura de Projeto": "2025-07-22", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Retrospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Sim", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 1162906.97, "OVERHEAT": 232581.39399999997}, {"Título Reduzido": "IMAGEM - VIRDX - DANIEL MOSER", "Data de abertura de Projeto": "2025-04-22", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo", "Pilar": "IIS", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": null, "OVERHEAT": 0.0}, {"Título Reduzido": "ONCOLOGIA - SBOC - PRECISA - Renata Bonadio", "Data de abertura de Projeto": "2025-07-29", "Status do Projeto": "Em negociação", "Especialidade": "Oncologia", "Tipo de estudo": "Intervencionista", "Relação temporal": "Prospectivo;#Retrospectivo", "Pilar": "API", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 150000.0, "OVERHEAT": 30000.0}, {"Título Reduzido": "ONCOLOGIA - AZ - CHC Leonardo Fonseca", "Data de abertura de Projeto": "2025-08-24", "Status do Projeto": "Planejamento", "Especialidade": "Oncologia", "Tipo de estudo": "Observacional", "Relação temporal": "Prospectivo", "Pilar": "CRO", "Lider": "Paulo de Alvarenga C Terra", "Necessidade de deliberação?": "Não", "Necessidade de apoio do recrutamento?": null, "Início da execução": null, "Fim da execução": null, "ORÇAMENTO": 1312906.97, "OVERHEAT": 262581.394}];
  const KPI_PROJECAO_2026 = 70; // alvo anual

  function toNumber(v) {
    if (v === null || v === undefined || v === '') return null;
    const n = Number(v);
    return isNaN(n) ? null : n;
  }

  function formatCurrency(v) {
    const n = toNumber(v);
    if (n === null) return '–';
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 });
  }

  function formatDateStr(str) {
    if (!str) return '–';
    const parts = String(str).split('-');
    if (parts.length !== 3) return str;
    return parts[2] + '/' + parts[1] + '/' + parts[0];
  }

  function getYear(str) {
    if (!str) return null;
    const parts = String(str).split('-');
    if (parts.length !== 3) return null;
    return parts[0];
  }

  function uniqueSorted(field) {
    const set = new Set();
    projects.forEach(p => {
      const v = p[field];
      if (v && String(v).trim() !== '') set.add(String(v).trim());
    });
    return Array.from(set).sort((a,b) => a.localeCompare(b,'pt-BR'));
  }

  function fillFilters() {
    const yearSel = document.getElementById('filter-year');
    const years = new Set();
    projects.forEach(p => {
      const y = getYear(p['Data de abertura de Projeto']);
      if (y) years.add(y);
    });
    Array.from(years).sort().forEach(y => {
      const o = document.createElement('option');
      o.value = y; o.textContent = y;
      yearSel.appendChild(o);
    });

    const especSel = document.getElementById('filter-especialidade');
    uniqueSorted('Especialidade').forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      especSel.appendChild(o);
    });

    const pilarSel = document.getElementById('filter-pilar');
    uniqueSorted('Pilar').forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      pilarSel.appendChild(o);
    });

    const liderSel = document.getElementById('filter-lider');
    uniqueSorted('Lider').forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      liderSel.appendChild(o);
    });

    const statusSel = document.getElementById('filter-status');
    uniqueSorted('Status do Projeto').forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      statusSel.appendChild(o);
    });
  }

  function parseDate(str) {
    if (!str) return null;
    const parts = String(str).split('-');
    if (parts.length !== 3) return null;
    const y = parseInt(parts[0],10);
    const m = parseInt(parts[1],10) - 1;
    const d = parseInt(parts[2],10);
    if (isNaN(y) || isNaN(m) || isNaN(d)) return null;
    return new Date(y,m,d);
  }

  function computeTemporalStatus(p) {
    const inicioStr = p['Início da execução'];
    const fimStr = p['Fim da execução'];
    const hoje = new Date();

    const inicio = parseDate(inicioStr);
    const fim = parseDate(fimStr);

    if (!inicio && !fim) {
      return 'Planejamento / Não iniciado';
    }

    if (inicio && inicio > hoje) {
      return 'Planejamento / Não iniciado';
    }

    if (inicio && (!fim || fim >= hoje)) {
      return 'Em execução';
    }

    if (fim && fim < hoje) {
      return 'Concluído';
    }

    return 'Planejamento / Não iniciado';
  }

  // applyFilters: includeYear = se true, respeita filtro de Ano; se false, ignora ano (para os gráficos de tendência/projeção)
  function applyFilters(includeYear) {
    const year = document.getElementById('filter-year').value;
    const espec = document.getElementById('filter-especialidade').value;
    const pilar = document.getElementById('filter-pilar').value;
    const lider = document.getElementById('filter-lider').value;
    const status = document.getElementById('filter-status').value;
    const busca = document.getElementById('filter-busca').value.toLowerCase();

    return projects.filter(p => {
      if (includeYear && year && getYear(p['Data de abertura de Projeto']) !== year) return false;
      if (espec && String(p['Especialidade']) !== espec) return false;
      if (pilar && String(p['Pilar']) !== pilar) return false;
      if (lider && String(p['Lider']) !== lider) return false;
      if (status && String(p['Status do Projeto']) !== status) return false;

      if (busca) {
        const texto = [
          p['Título Reduzido'],
          p['Especialidade'],
          p['Pilar'],
          p['Lider'],
          p['Status do Projeto']
        ].filter(Boolean).join(' ').toLowerCase();
        if (!texto.includes(busca)) return false;
      }
      return true;
    });
  }

  let anualChart = null;
  let mensalChart = null;

  function renderAnual(listNoYear) {
    // Agrupa por ano de abertura (recorte filtrado, sem filtro de ano)
    const map = new Map();
    listNoYear.forEach(p => {
      const y = getYear(p['Data de abertura de Projeto']);
      if (!y) return;
      map.set(y, (map.get(y) || 0) + 1);
    });

    let years = Array.from(map.keys()).sort();
    if (years.length === 0) {
      years = ['2025'];
      map.set('2025', 0);
    }
    const lastYear = parseInt(years[years.length - 1], 10);
    const projYear = lastYear + 1; // 2026 tipicamente

    // Garante que o ano projetado esteja na série
    if (!map.has(projYear.toString())) {
      years.push(projYear.toString());
    }
    const dataHist = years.map(y => y === projYear.toString() ? null : (map.get(y) || 0));
    const dataProj = years.map(y => y === projYear.toString() ? KPI_PROJECAO_2026 : null);
    const faixaMin = KPI_PROJECAO_2026 * 0.8;
    const faixaMax = KPI_PROJECAO_2026 * 1.2;
    const dataFaixaMin = years.map(y => y === projYear.toString() ? faixaMin : null);
    const dataFaixaMax = years.map(y => y === projYear.toString() ? faixaMax : null);

    const ctx = document.getElementById('chartAnual').getContext('2d');
    if (anualChart) anualChart.destroy();
    anualChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          {
            label: 'Histórico',
            data: dataHist,
            spanGaps: true,
            borderWidth: 2,
            tension: 0.3
          },
          {
            label: 'Projeção central (' + projYear + ')',
            data: dataProj,
            borderWidth: 0,
            pointRadius: 5,
            pointHoverRadius: 6
          },
          {
            label: 'Faixa projetada (' + projYear + ')',
            data: dataFaixaMax,
            borderWidth: 0,
            pointRadius: 0,
            fill: {
              target: {
                value: faixaMin
              }
            }
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              font: { size: 10 }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.y;
                if (v == null) return null;
                return ' ' + v.toFixed(0) + ' estudo(s)';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            },
            title: {
              display: true,
              text: 'Nº de estudos / ano'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Ano'
            }
          }
        }
      }
    });

    const pill = document.getElementById('pill-anual-info');
    pill.textContent = 'Projeção ' + projYear + ': ' + KPI_PROJECAO_2026 + ' estudo(s)';
  }

  function renderMensal(listNoYear) {
    // Base: último ano disponível no recorte filtrado (esperado 2025)
    const years = listNoYear
      .map(p => getYear(p['Data de abertura de Projeto']))
      .filter(Boolean);
    if (years.length === 0) {
      const ctx = document.getElementById('chartMensal').getContext('2d');
      if (mensalChart) mensalChart.destroy();
      mensalChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: []
        }
      });
      return;
    }
    const sortedYears = years.sort();
    const baseYear = sortedYears[sortedYears.length - 1]; // ex: 2025

    const labels = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const real2025 = new Array(12).fill(0);

    listNoYear.forEach(p => {
      const y = getYear(p['Data de abertura de Projeto']);
      if (y !== baseYear) return;
      const d = p['Data de abertura de Projeto'];
      if (!d) return;
      const parts = String(d).split('-');
      if (parts.length !== 3) return;
      const m = parseInt(parts[1],10);
      if (!isNaN(m) && m >= 1 && m <= 12) real2025[m-1] += 1;
    });

    const totalBase = real2025.reduce((a,b)=>a+b,0);
    let proj2026 = new Array(12).fill(0);
    if (totalBase > 0) {
      const fator = KPI_PROJECAO_2026 / totalBase;
      proj2026 = real2025.map(v => v * fator);
    }

    const projYear = parseInt(baseYear,10) + 1;

    const ctx = document.getElementById('chartMensal').getContext('2d');
    if (mensalChart) mensalChart.destroy();
    mensalChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: baseYear + ' (real, filtro atual)',
            data: real2025,
            borderWidth: 1
          },
          {
            label: projYear + ' (projeção, filtro atual)',
            data: proj2026,
            borderWidth: 1
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              font: { size: 10 }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.y || 0;
                return ' ' + v.toFixed(1) + ' estudo(s) / mês';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            },
            title: {
              display: true,
              text: 'Nº de estudos / mês'
            }
          }
        }
      }
    });

    const pill = document.getElementById('pill-mensal-info');
    pill.textContent = baseYear + ' real · Projeção ' + projYear + ' para ' + KPI_PROJECAO_2026 + ' estudos/ano';
  }

  function renderLifeSummary(listWithYear) {
    const naoIniciado = listWithYear.filter(p => computeTemporalStatus(p) === 'Planejamento / Não iniciado').length;
    const execucao = listWithYear.filter(p => computeTemporalStatus(p) === 'Em execução').length;
    const concluido = listWithYear.filter(p => computeTemporalStatus(p) === 'Concluído').length;

    const el = document.getElementById('life-summary');
    el.innerHTML = `
      <p>Classificação baseada em <strong>Início da execução</strong> e <strong>Fim da execução</strong>, comparando com a data de hoje:</p>
      <ul>
        <li class="status-nao-iniciado">
          <span class="status-pill status-nao-iniciado">
            <span class="status-dot"></span> Planejamento / Não iniciado
          </span>
          &nbsp;– ${naoIniciado} projeto(s)
        </li>
        <li class="status-execucao">
          <span class="status-pill status-execucao">
            <span class="status-dot"></span> Em execução
          </span>
          &nbsp;– ${execucao} projeto(s)
        </li>
        <li class="status-concluido">
          <span class="status-pill status-concluido">
            <span class="status-dot"></span> Concluído
          </span>
          &nbsp;– ${concluido} projeto(s)
        </li>
      </ul>
      <p>Ao avançar no tempo e atualizar a planilha, os estudos com fim de execução no passado migram automaticamente para “Concluídos”.</p>
    `;
  }

  function renderCards(listWithYear) {
    const totalProjetos = listWithYear.length;
    const totalOrc = listWithYear.reduce((acc,p)=>acc+(toNumber(p['ORÇAMENTO'])||0),0);
    const totalOver = listWithYear.reduce((acc,p)=>acc+(toNumber(p['OVERHEAT'])||0),0);
    const comOrc = listWithYear.filter(p => toNumber(p['ORÇAMENTO']) !== null).length;

    const cardsDiv = document.getElementById('cards-summary');
    cardsDiv.innerHTML = `
      <div class="card">
        <div class="card-label">Total de projetos</div>
        <div class="card-value">${totalProjetos}</div>
        <div class="card-sub">Portfólio filtrado na visão atual (incluindo ano, se selecionado).</div>
      </div>
      <div class="card">
        <div class="card-label">Projetos com orçamento</div>
        <div class="card-value">${comOrc}</div>
        <div class="card-sub">Estudos com valor de ORÇAMENTO preenchido.</div>
      </div>
      <div class="card">
        <div class="card-label">Orçamento total</div>
        <div class="card-value">${formatCurrency(totalOrc)}</div>
        <div class="card-sub">Soma do orçamento dos projetos filtrados.</div>
      </div>
      <div class="card">
        <div class="card-label">Overhead potencial</div>
        <div class="card-value">${formatCurrency(totalOver)}</div>
        <div class="card-sub">Receita indireta associada (coluna OVERHEAT).</div>
      </div>
      <div class="card">
        <div class="card-label">Projeção de volume</div>
        <div class="card-value">${KPI_PROJECAO_2026} estudo(s) em 2026</div>
        <div class="card-sub">KPI anual alvo, redistribuído mensalmente conforme o perfil de 2025.</div>
      </div>
    `;
  }

  function renderTable(listWithYear) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    listWithYear.forEach(p => {
      const tr = document.createElement('tr');

      const tdTitulo = document.createElement('td');
      tdTitulo.innerHTML = `
        <div style="font-weight:500;">${p['Título Reduzido'] || '-'}</div>
        <div style="font-size:0.7rem; color:#6b7280; margin-top:2px;">
          ${computeTemporalStatus(p)}
        </div>`;
      tr.appendChild(tdTitulo);

      const tdEsp = document.createElement('td');
      tdEsp.textContent = p['Especialidade'] || '–';
      tr.appendChild(tdEsp);

      const tdPilar = document.createElement('td');
      tdPilar.textContent = p['Pilar'] || '–';
      tr.appendChild(tdPilar);

      const tdLider = document.createElement('td');
      tdLider.textContent = p['Lider'] || '–';
      tr.appendChild(tdLider);

      const tdStatus = document.createElement('td');
      tdStatus.textContent = p['Status do Projeto'] || '–';
      tr.appendChild(tdStatus);

      const tdAbertura = document.createElement('td');
      tdAbertura.textContent = formatDateStr(p['Data de abertura de Projeto']);
      tr.appendChild(tdAbertura);

      const tdInicio = document.createElement('td');
      tdInicio.textContent = formatDateStr(p['Início da execução']);
      tr.appendChild(tdInicio);

      const tdFim = document.createElement('td');
      tdFim.textContent = formatDateStr(p['Fim da execução']);
      tr.appendChild(tdFim);

      const tdOrc = document.createElement('td');
      tdOrc.textContent = formatCurrency(p['ORÇAMENTO']);
      tr.appendChild(tdOrc);

      const tdOver = document.createElement('td');
      tdOver.textContent = formatCurrency(p['OVERHEAT']);
      tr.appendChild(tdOver);

      tbody.appendChild(tr);
    });

    document.getElementById('count-projetos').textContent = listWithYear.length;
  }

  function updateAll() {
    const listWithYear = applyFilters(true);   // respeita filtro de ano
    const listNoYear   = applyFilters(false);  // ignora filtro de ano (para série histórica e projeção)

    renderCards(listWithYear);
    renderAnual(listNoYear);
    renderMensal(listNoYear);
    renderLifeSummary(listWithYear);
    renderTable(listWithYear);
  }

  function setupTableToggle() {
    const btn = document.getElementById('toggle-table-btn');
    const wrapper = document.getElementById('table-wrapper');
    let visible = false;
    btn.addEventListener('click', () => {
      visible = !visible;
      wrapper.style.display = visible ? 'block' : 'none';
      btn.textContent = visible ? 'Esconder tabela detalhada' : 'Mostrar tabela detalhada';
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    fillFilters();
    ['filter-year','filter-especialidade','filter-pilar','filter-lider','filter-status','filter-busca']
      .forEach(id => document.getElementById(id).addEventListener('input', updateAll));
    setupTableToggle();
    updateAll();
  });
</script>
</body>
</html>
